---
title: "Get Started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Get Started}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
# Make sure the examples are available 
# use try-catch since Github may limit rate
library(bidsr)
has_examples <- tryCatch({
  example_root <- download_bids_examples()
  TRUE
}, error = function(e) {
  FALSE
})

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = has_examples,
  echo = TRUE
)
```

Brain Imaging Data Structure (`BIDS`) is a standard for organizing neuroimaging and behavioral data (see https://bids.neuroimaging.io/index.html). 

The goal of package `bidsr` is to provide comprehensive tools to query and manipulate 'BIDS' data files. 

This vignette aims to demonstrate high-level tools to query a 'BIDS' project. The code requires executing a built-in command to download ['BIDS' example data-sets](https://github.com/bids-standard/bids-examples). Please copy-paste-run the following R commands:

```{r setup}
library(bidsr)
example_root <- download_bids_examples()
```

## Overview of a `BIDS` project

Let's inspect the project `ieeg_motorMiller2007` from the official `BIDS` example repository:

```{r}
project_path <- file.path(example_root, "ieeg_motorMiller2007")
project <- bids_project(path = project_path)

print(project)
```

### File `dataset_description.json`

The top-level data description can be parsed via

```{r}
description <- project$get_dataset_description()

print(description)
```

To obtain the values, use `$` operator (same as `.` in `Python`):

```{r}
description$BIDSVersion
```

### File `participants.tsv`

File `participants.tsv` is a top-level tabular that lists all the subjects. This file can be queried via method `get_participants`:

```{r}
participants <- project$get_participants()
```

Alternatively, we can read any `tsv` file with `as_bids_tabular`

```{r}
participant_path <- file.path(project, "participants.tsv")
as_bids_tabular(participant_path)
```

## Instantiate a `BIDS` subject

Given a project path or instance, a `BIDS` subject can be instantiated via

```{r}
subject <- bids_subject(
  project = project, 
  subject_code = "sub-bp"
)

print(subject)
```

All `BIDS` subjects have entity key `sub-` that marks the subject code, for example, `sub-bp` means subject `bp`, hence the entity key `sub-` can be omitted, and `bidsr` accepts input such as `subject_code = "bp"`. 

If `project` is not instantiated, its path is also acceptable, check this alternative:

```{r}
subject <- bids_subject(
  project = project_path, 
  subject_code = "bp"
)
```

### Raw, source, or derivative data

`BIDS` mainly focuses on regulating the raw data, however, it also supports formatting source data and derivatives. The corresponding paths can be queried via `get_path` method. To query the root path for raw/source data,

```{r}
subject$get_path("raw")
subject$get_path("source")
```

For derivatives, please specify the derivative names, for example:

```{r}
subject$get_path("derivative", derivative_prefix = "freesurfer")
```


### Query subject files by types

The official `BIDS` and its extensions support various of data types, such as `anat`, `func`, `meg`, `eeg`, `ieeg`, etc.

To query the data files by type, use `query_modality` method:

```{r}
ieeg_table <- subject$query_modality("ieeg")
ieeg_table
```

The first column contains a list of file instances. Here's an example to read the `ACPC` electrode coordinates:

```{r}
subset_result <- subset(ieeg_table, space == "ACPC" & suffix == "electrodes")
path_parsed <- subset_result$parsed[[1]]
print(path_parsed)

electrode_path <- file.path(project, path_parsed)
as_bids_tabular(electrode_path)
```


## `BIDS` entity

Object `path_parsed` is a file entity class, with the entities parsed

```{r}
class(path_parsed)

path_parsed$get_entity("space")

path_parsed$entities
```

If supported by schema, the `BIDS` entity rules for the file can be queried via

```{r}
path_parsed$get_entity_rules()
```



